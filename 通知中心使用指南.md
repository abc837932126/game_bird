# 通知中心系统使用指南

## 概述

通知中心系统是一个统一管理所有 WebSocket 通知的系统，可以方便地添加各种通知类型，如好友申请、婚姻提议、训练完成等。

## 架构说明

### 前端
- **文件**: `src/game/notification-center.js`
- **功能**: 统一管理所有通知的注册、注销和显示
- **访问**: 通过 `game.notificationCenter` 访问

### 后端
- **文件**: `websocket/types.ts`
- **功能**: 提供通知类型枚举和发送通知的辅助函数
- **类型**: `NotificationType` 枚举定义了所有通知类型

## 如何添加新的通知类型

### 步骤 1: 在后端添加通知类型

在 `websocket/types.ts` 的 `NotificationType` 枚举中添加新的通知类型：

```typescript
export enum NotificationType {
    // ... 现有类型 ...

    // 你的新通知类型
    YOUR_NEW_NOTIFICATION = 'your_new_notification',
}
```

### 步骤 2: 在后端发送通知

在需要发送通知的地方使用 `sendNotification` 函数：

```typescript
import { sendNotification, NotificationType } from '../../websocket/types.js';
import { findPlayerConnection } from '../../websocket/server.js';

// 查找目标玩家的 WebSocket 连接
const targetPlayerWs = findPlayerConnection(targetPlayerId);

if (targetPlayerWs) {
    // 发送通知
    sendNotification(
        targetPlayerWs,
        'your_module',  // 模块名称，如 'player_friend', 'player_marriage' 等
        NotificationType.YOUR_NEW_NOTIFICATION,
        {
            // 通知数据
            title: '通知标题',
            message: '通知消息',
            // ... 其他业务数据 ...
        }
    );
}
```

### 步骤 3: 在前端注册监听器

在需要接收通知的组件中注册监听器：

```javascript
import { inject, onMounted, onUnmounted } from 'vue'
import { ElNotification } from 'element-plus'

const game = inject('game')

// 通知处理函数
const handleYourNotification = async (message) => {
    console.log('收到通知:', message.data)

    // 处理业务逻辑（如刷新数据）
    await game.your_module.update()

    // 显示通知提示
    ElNotification({
        title: message.data.title || '新通知',
        message: message.data.message || '您有新的通知',
        type: 'info',
        duration: 3000
    })
}

onMounted(() => {
    // 初始化通知中心（只需要在应用入口初始化一次）
    game.notificationCenter.init()

    // 注册通知监听器
    game.notificationCenter.on(
        'your_module',              // 模块名称（与后端对应）
        'your_new_notification',    // 通知类型（与后端对应）
        handleYourNotification      // 处理函数
    )
})

onUnmounted(() => {
    // 组件卸载时移除监听器
    game.notificationCenter.off(
        'your_module',
        'your_new_notification',
        handleYourNotification
    )
})
```

## 现有通知类型

当前系统已定义的通知类型：

### 鸟巢相关
- `NEST_UPDATED` - 鸟巢更新（已实现）
- `NEST_PAIRING_COMPLETE` - 配对完成

### 好友相关
- `FRIEND_REQUEST` - 好友申请
- `FRIEND_ACCEPTED` - 好友接受

### 婚姻相关
- `MARRIAGE_PROPOSAL` - 婚姻提议
- `MARRIAGE_ACCEPTED` - 婚姻接受
- `MARRIAGE_DIVORCED` - 离婚

### 训练相关
- `TRAINING_COMPLETE` - 训练完成

### 捕获相关
- `TRAP_READY` - 陷阱就绪
- `TRAP_CAUGHT` - 捕获成功

### 天梯相关
- `LADDER_MATCH_FOUND` - 匹配成功
- `LADDER_BATTLE_RESULT` - 战斗结果

### 聊天相关
- `CHAT_MESSAGE` - 聊天消息

### 系统相关
- `SYSTEM_ANNOUNCEMENT` - 系统公告
- `SYSTEM_MAINTENANCE` - 系统维护

## 实际示例：鸟巢更新通知

### 后端代码 (`api/player_nest/index.ts:429-438`)

```typescript
// 如果操作的是好友的鸟巢，通知好友刷新
if (!isOwnNest) {
    const friendConnection = findPlayerConnection(targetNestOwnerId);
    if (friendConnection) {
        sendNotificationToPlayer(friendConnection, 'player_nest', 'nest_updated', {
            nest_owner_id: targetNestOwnerId,
            updated_by: ws.playerId
        });
    }
}
```

### 前端代码 (`components/home/index.vue:41-54,65`)

```javascript
// 巢穴更新通知处理函数
const handleNestUpdate = async (message) => {
    // 当好友在我的巢穴设置鸟时，收到通知并刷新
    if (message.data?.nest_owner_id === game.player.data?.id) {
        await game.player_nest.update()
        // 显示通知提示
        ElNotification({
            title: '鸟巢更新',
            message: '好友在你的鸟巢放置了鸟',
            type: 'info',
            duration: 3000
        })
    }
}

// 注册监听器
game.notificationCenter.on('player_nest', 'nest_updated', handleNestUpdate)
```

## 高级功能

### 自动显示通知弹窗

通知中心支持在注册时自动显示���知弹窗：

```javascript
game.notificationCenter.on(
    'your_module',
    'your_notification',
    handleYourNotification,
    {
        showNotification: true,  // 自动显示通知
        formatMessage: (message) => {
            return {
                title: '自定义标题',
                body: message.data.message
            }
        }
    }
)
```

### 查看通知历史

```javascript
// 获取通知历史记录
const history = game.notificationCenter.getHistory()
console.log('通知历史:', history)

// 清空历史记录
game.notificationCenter.clearHistory()
```

### 批量发送通知（后端）

如果需要向多个玩家发送相同的通知：

```typescript
import { broadcastNotification, NotificationType } from '../../websocket/types.js';

const playerConnections = [ws1, ws2, ws3];

broadcastNotification(
    playerConnections,
    'system',
    NotificationType.SYSTEM_ANNOUNCEMENT,
    {
        title: '系统公告',
        message: '服务器将在 10 分钟后维护'
    }
);
```

## 最佳实践

1. **通知类型命名**: 使用描述性的名称，如 `FRIEND_REQUEST` 而不是 `FR`
2. **数据结构一致性**: 所有通知数据都应包含 `title` 和 `message` 字段
3. **及时注销监听器**: 在组件卸载时一定要注销监听器，避免内存泄漏
4. **通知提示**: 合理使用 `ElNotification` 提示用户，避免过度打扰
5. **业务逻辑分离**: 通知处理函数中只做必要的数据刷新，复杂逻辑应该放在业务模块中

## 注意事项

1. 通知中心只需要初始化一次（通常在应用入口或首页）
2. 同一个通知类型可以注册多个处理器
3. 通知历史默认只保存最近 50 条记录
4. WebSocket 断开重连后，需要重新注册监听器（通常框架会自动处理）
